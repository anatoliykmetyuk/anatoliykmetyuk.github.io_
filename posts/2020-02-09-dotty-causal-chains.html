<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>
  <!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MGZJP4K');</script>
<!-- End Google Tag Manager -->

  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Anatolii Kmetiuk - Following Causal Chains in Dotty Codebase</title>
<meta name="author" content="Anatolii Kmetiuk" />

<meta name="description" content="TODO">
<meta name="keywords" content="scala,programming,functional programming,category theory,kmetiuk,kmetyuk,anatolii kmetiuk,anatoliy kmetyuk">

<!-- Facebook tags -->
<meta property="og:title" content="Following Causal Chains in Dotty Codebase">
<meta property="og:type" content="article">
<meta property="og:url" content="http://akmetiuk.com/posts/2020-02-09-dotty-causal-chains.html">
<meta property="og:image" content="http://akmetiuk.com/assets/imgs/avatar_100.png">
<meta property="og:description" content="TODO">
<meta property="og:site_name" content="The blog of Anatolii Kmetiuk">
<meta property="og:locale" content="en-GB">

<!-- Twitter tags -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:description" content="TODO" />
<meta name="twitter:title" content="Following Causal Chains in Dotty Codebase" />
<meta name="twitter:site" content="@AKmetyuk" />
<meta name="twitter:image" content="http://akmetiuk.com/assets/imgs/avatar_100.png" />
<meta name="twitter:creator" content="@AKmetyuk" />

  <link rel="canonical" href="http://akmetiuk.com/posts/2020-02-09-dotty-causal-chains.html" />

  <link href="//fonts.googleapis.com/css?family=Open+Sans:600,800" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="/favicon.png">
  <link rel="alternate" type="application/atom+xml" title="Anatolii Kmetiuk" href="http://akmetiuk.com/atom.xml" />

  <link rel="stylesheet" href="/assets/all.css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha256-k2/8zcNbxVIh5mnQ52A0r3a6jAgMGxFJFE2707UxGCk= sha512-ZV9KawG2Legkwp3nAlxLIVFudTauWuBpC10uEafMHYL0Sarrz5A7G79kXh5+5+woxQ5HM559XX2UZjMJ36Wplg==" crossorigin="anonymous">
</head>
<body>
  <!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MGZJP4K"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

  <div class="container">
    <div class="four columns sidebar">
      <nav>
  <h1>Hi.</h1>
  <a href="/">
    <img src="/assets/imgs/avatar_200.png" id="logo" alt="Blog logo"/>
  </a>
  <h2>I'm <a href="/">Anatolii Kmetiuk</a>.</h2>
  <div id="bio">
    <p>ðŸ’»I'm a compiler engineer at LAMP/EPFL, working on Scala 3.</p>
    <p>Check out the books I've written:</p>
    <p>ðŸ“•<a href="https://www.amazon.com/Mastering-Functional-Programming-techniques-programming/dp/1788620798/">Mastering Functional Programming</a> â€“ the motivation behind purely functional libraries such as Cats.</p>
    <p>ðŸ“•<a href="/assets/files/story-of-one-library.pdf">[Free] A Story of One Library</a> â€“ a commit-by-commit analysis of an application from the very start. The challenges that were arising during the implementation are addressed in a functional way, so that the reader can understand the motivation behind the functional techniques.</p>
  </div>
  <div id="social">
    Where to find me:
    <div id="stalker">
      <a title="anatoliykmetyuk on Github" href="https://github.com/anatoliykmetyuk">
        <i class="fa fa-github-square"></i>
      </a>

      <a title="Anatolii Kmetiuk on LinkedIn" href="https://www.linkedin.com/in/anatoliykmetyuk">
        <i class="fa fa-linkedin-square"></i>
      </a>
    </div>
  </div>
</nav>
    </div>

    <div class="eleven columns content">
      <p class="meta">
Feb 09, 2020 <a href="/"> <i class="home fa fa-home"></i> </a>
</p>
<h1 class="title">
Following Causal Chains in Dotty Codebase
</h1>
<div id="post">
<div class="toc">
<ul>
<li>
<a href="#framing-the-problem">Framing the Problem</a>
</li>
<li>
<a href="#the-domain-of-debugging">The Domain of Debugging</a>
<ul>
<li>
<a href="#successful-and-failing-cases">Successful and Failing Cases</a>
</li>
<li>
<a href="#deltas">Deltas</a>
</li>
<li>
<a href="#tracers">Tracers</a>
</li>
</ul>
</li>
<li>
<a href="#the-tracking-of-the-debugging-process">The Tracking of the Debugging Process</a>
</li>
</ul>
</div>
<div class="body">
<h1 id="framing-the-problem">
Framing the Problem
</h1>
<p>
You can deal with a problem in two ways. First, the intuitive way: go at it and follow your common sense. In process, however, you'll discover recurring patterns. Some sub-problem that pops up constantly or a technique you apply time after time. Hence the second way is to frame the problem. Give the recurring patterns names, describe how they relate to each other. This way, you develop the domain of the problem.
</p>
<p>
The advantages of having the problem framed are:
</p>
<ul>
<li>
You pay attention to what's important and filter out everything else. If you are working on intuition, every detail might matter. However if the problem and the solution are described in terms of some domain, all that matters is to see the entities of that domain.
</li>
<li>
You are able to communicate your findings to others. This ability facilitates progress sharing and collaboration. â€“ You are able to store your findings for later use. With intuitive approach this is not the case by definition, since you don't have the words to describe what you see. The advantage here is that you're able to free your memory and mental resources and hence scale up the size of the problems you can solve.
</li>
</ul>
<h1 id="the-domain-of-debugging">
The Domain of Debugging
</h1>
<h2 id="successful-and-failing-cases">
Successful and Failing Cases
</h2>
<p>
One recurring theme when dealing with Dotty issues is that you have a program which makes the compiler exhibit some unwanted behavior. For example, a recent issue <a href="https://github.com/lampepfl/dotty/issues/8188">#8188</a>:
</p>
<div class="sourceCode">
<pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">object</span> Test {
  extension StrDeco <span class="fu">on</span> (tree: String) {
    <span class="kw">def</span> <span class="fu">show</span>(given DummyImplicit): String = ???
    <span class="kw">def</span> <span class="fu">show</span>(color: Boolean)(given DummyImplicit): String = ???
  }

  <span class="kw">val</span> c: Any = <span class="st">&quot;foo&quot;</span>.<span class="fu">show</span>
}</code></pre>
</div>
<p>
Produces the following compilation error:
</p>
<div class="sourceCode">
<pre class="sourceCode scala"><code class="sourceCode scala"><span class="dv">11</span> |  <span class="kw">val</span> c: Any = <span class="st">&quot;foo&quot;</span>.<span class="fu">show</span>
   |               ^^^^^^^^^^
   |      value show is not a member of String.
   |      An extension method was tried, but could not be fully constructed:
   |
   |          Test.<span class="fu">StrDeco</span>.<span class="fu">show</span>(<span class="st">&quot;foo&quot;</span>)</code></pre>
</div>
<p>
However, tweak it a little bit as follows:
</p>
<div class="sourceCode">
<pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">object</span> Test {
  extension StrDeco <span class="fu">on</span> (tree: String) {
    <span class="kw">def</span> <span class="fu">show</span>(given DummyImplicit): String = ???
    <span class="kw">def</span> <span class="fu">show</span>(color: Boolean)(given DummyImplicit): String = ???
  }

  <span class="kw">val</span> c: String = <span class="st">&quot;foo&quot;</span>.<span class="fu">show</span>  <span class="co">// The type of the variable has changed</span>
}</code></pre>
</div>
<p>
And it compiles successfully. The existence of the program very close to the original one that doesn't exhibit the undesired behavior is interesting because if the programs are close, the compiler must also do more-or-less the same thing while compiling them.
</p>
<p>
It makes sense to give these two cases their own names, Successful and Failing respectively, thus defining our domain. There may be multiple of them since different modifications may produce different interesting behavior.
</p>
<h2 id="deltas">
Deltas
</h2>
<p>
An intuitive way to go about establishing the reason why the failing case exhibits the undesired behavior is to see what exactly the compiler did differently than in the successful case. This way of reasoning is especially appealing because one such difference is immediately obvious: the undesired behavior itself, for example a compilation error, and the absence of it in the successful case.
</p>
<p>
Since these differences are a recurring pattern, we can give them a name â€“ Delta is a good one since it's usually used to indicate difference.
</p>
<p>
Once you have one such delta found, it usually points to another one: the one that causes it. You can uncover it by asking the question, &quot;why did this difference take place?&quot;.
</p>
<p>
Then, you rinse and repeat until you arrive to the root cause of the undesired behavior.
</p>
<p>
You may need to do it dozens of times until you arrive to the root cause. Defining the concept of a delta enables you to record the deltas you've encountered, hence unloading your mind without fear of losing your progress.
</p>
<h2 id="tracers">
Tracers
</h2>
<p>
The tracers are statements that output something to the terminal. They are the primary way to detect the deltas.
</p>
<p>
Sometimes a single trace is printed more than once. This can happen in case of recursive methods or when a method is called from a loop. It is often the case that the correct and failing programs' traces are exactly the same â€“ up to a certain point.
</p>
<p>
In the context of having a single tracer being potentially executed many times, the problem arises that it becomes harder to describe deltas. If that's just one tracing line for the successful and failing case, you can just specify that line as your delta. But if that's a hundred lines and the differences don't manifest until a few dozens lines in?
</p>
<p>
Motivated by the above, each individual tracer output can be labelled by an MD5 hash which is computed from both the string being output as well as all the other strings that were output previously as part of tracing.
</p>
<p>
This way, one can refer to the desired line of the tracing output by its hash and the delta definition boils down to naming the first hashes that were different for the successful and failing cases.
</p>
<h1 id="the-tracking-of-the-debugging-process">
The Tracking of the Debugging Process
</h1>
<p>
I tried out one way to capture the deltas last week. I have a spreadsheet like this:
</p>
<p>
<a href="/assets/visuals/2020-02-08-debugging-domain/delta-tracking.png"><img src="/assets/visuals/2020-02-08-debugging-domain/delta-tracking.png" width="100%" target="_blank"/></a>
</p>
<p>
The columns are as follows:
</p>
<ul>
<li>
Where (Above) â€“ the line of code at which a tracer is injected. &quot;Above&quot; means &quot;put the tracer on that line, above anything that was previously on that line&quot;.
</li>
<li>
Trace â€“ the string being output by the tracer. If the tracer is more than one command, write down the tracer code at that column, otherwise â€“ just a string being printed.
</li>
<li>
Delta Successful â€“ for the successful case, what is the first trace entry that differs from that of the failing one?
</li>
<li>
Delta Failing â€“ for the failing case, what is the first trace entry that differs from that of the successful one?
</li>
</ul>
<p>
Defined that way, the deltas are self-consistent: you can reproduce them on a clean codebase.
</p>
</div>
</div>
<div id="disqus_thread">

</div>
<script>
var disqus_config = function () {
this.page.url = 'http://akmetiuk.com/posts/2020-02-09-dotty-causal-chains.html';
this.page.identifier = '/posts/2020-02-09-dotty-causal-chains.html';
};

(function() {
var d = document, s = d.createElement('script');

s.src = '//anatoliikmetiukblog.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>
Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>


      <div class="footer">
        <div class="disclaimer">
  <p>
    Â© Anatolii Kmetiuk, 2016 &mdash; built using <a href="https://github.com/swanson/lagom">Lagom theme</a>. Powered by <a href="https://github.com/anatoliykmetyuk/thera">Thera</a>. The sources of this site are availabel on <a href="https://github.com/anatoliykmetyuk/anatoliykmetyuk.github.io">GitHub</a>.
  </p>
</div>
      </div>
    </div>
  </div>
</body>
</html>